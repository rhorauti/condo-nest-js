generator postgresClient {
  provider = "prisma-client-js"
  output   = "../../node_modules/@prisma/postgres-client"
}

datasource postgres {
  provider = "postgresql"
}

enum AddressType {
  HOUSE
  APARTMENT
}

model Condo {
  idCondo  Int     @default(autoincrement())
  name     String  @unique(map: "UQ_condo_name")

  users    UserCondo[]
  address  Address?

  @@id([idCondo], map: "PK_condo")
}

model UserCondo {
  idUser   Int
  idCondo  Int

  user     User   @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  condo    Condo  @relation(fields: [idCondo], references: [idCondo], onDelete: Cascade)

  joinedAt DateTime @default(now()) @postgres.Timestamptz

  @@id([idUser, idCondo])
  @@map("user_condo")
}

enum USER_ROLES {
  USER
  ADMIN
  ADMIN_ROOT
}

model User {
  idUser              Int         @default(autoincrement())
  email               String      @unique(map: "UQ_user_email")
  password            String
  name                String
  birthDate           DateTime?   @postgres.Timestamptz
  photoPath           String?
  role                USER_ROLES
  phone               String?
  isWhattsapp         Boolean     @default(false)
  agreedWithTerms     Boolean     @default(false)
  isActive            Boolean     @default(false)
  createdAt           DateTime    @default(now()) @postgres.Timestamptz

  address             Address[]

  posts               Post[]
  comments            Comment[]
  postLike            PostLike[]
  commentLike         CommentLike[]
  condos              UserCondo[]

  @@id([idUser], map: "PK_user")
}

model Address {
  idAddress   Int         @default(autoincrement())
  type        AddressType @default(HOUSE)
  street      String?
  number      String?
  district    String?
  city        String?
  state       String?
  postalCode  String?
  block       String?
  blockType   Int?   
  lot         String?
  lotType     Int?

  idUser      Int?
  user        User?       @relation(fields: [idUser], references: [idUser],  onDelete: Cascade)

  idCondo     Int?         @unique
  condo       Condo?      @relation(fields: [idCondo], references: [idCondo], onDelete: Cascade)

  @@id([idAddress], map: "PK_address")

}

model Post {
  idPost      Int       @default(autoincrement())
  postType    Int
  description String
  createdAt   DateTime  @default(now()) @postgres.Timestamptz

  idUser      Int
  user        User      @relation(fields: [idUser], references: [idUser], onDelete: Cascade)

  comments    Comment[]
  postLike    PostLike[]
  postMedia   Media[]

  @@id([idPost], map: "PK_post")
  @@index([idUser])  
  @@index([createdAt])  
}

model Comment {
  idComment       Int             @default(autoincrement())
  description     String
  mediaList       String[]
  createdAt       DateTime        @default(now()) @postgres.Timestamptz

  idUser          Int
  user            User            @relation(fields: [idUser], references: [idUser], onDelete: Cascade)

  idPost          Int
  post            Post            @relation(fields: [idPost], references: [idPost], onDelete: Cascade)

  idParent        Int?
  parent          Comment?        @relation("CommentReplies", fields: [idParent], references: [idComment], onDelete: Cascade)
  replies         Comment[]       @relation("CommentReplies")
  commentLike     CommentLike[]
  postMedia       Media[]

  @@id([idComment], map: "PK_comment")
  @@index([idPost])  
  @@index([idUser])
  @@index([createdAt])
}

model PostLike {
  idPostLike      Int     @id @default(autoincrement())
  idUser          Int
  idPost          Int

  user            User    @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  post            Post    @relation(fields: [idPost], references: [idPost],  onDelete: Cascade)

  @@unique([idUser, idPost]) 
  @@index([idPost])
}

model CommentLike {
  idCommentLike     Int         @id @default(autoincrement())
  idUser            Int
  idComment         Int        

  user              User        @relation(fields: [idUser], references: [idUser], onDelete: Cascade)
  comment           Comment     @relation(fields: [idComment], references: [idComment],  onDelete: Cascade)

  @@unique([idUser, idComment]) 
  @@index([idComment])
}

model Media {
  idMedia           Int         @id @default(autoincrement())
  idPost            Int?
  idComment         Int?
  idProduct         Int?
  mediaPath         String
  size              Int?
  format            String?
  
  post              Post?        @relation(fields: [idPost], references: [idPost], onDelete: Cascade)
  comment           Comment?     @relation(fields: [idComment], references: [idComment], onDelete: Cascade)
  product           Product?     @relation(fields: [idProduct], references: [idProduct], onDelete: Cascade)
  
  @@index([idPost, idComment])
}

model Product {
  idProduct       Int           @id @default(autoincrement())
  name            String        
  media           Media[]
}

